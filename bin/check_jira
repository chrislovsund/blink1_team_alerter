#!/usr/bin/env ruby

require "bundler/setup"
require "blink1_team_alerter"
require 'optparse'

options = {}
options[:url] = ENV["URL"]

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: check_jira [options]"

  opts.on("-uUSERNAME", "--username=USERNAME", "JIRA username") do |r|
    options[:username] = r
  end
  opts.on("-pPASSWORD", "--password=PASSWORD", "JIRA password") do |r|
    options[:password] = r
  end
  opts.on("-hHOST", "--host=HOST", "JIRA Host Name") do |r|
    options[:host] = r
  end
  opts.on("-kPROJECTKEY", "--projectkey=PROJECTKEY", "JIRA project key") do |r|
    options[:project_key] = r
  end
end

begin
  optparse.parse!
  mandatory = [:username, :password, :host, :project_key]
  missing = mandatory.select{ |param| options[param].nil? }
  unless missing.empty?
    puts "Missing options: #{missing.join(', ')}"
    puts optparse
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  puts optparse
  exit
end

Blink1TeamAlerter.check_jira options[:username], options[:password], options[:host], options[:project_key]
