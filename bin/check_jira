#!/usr/bin/env ruby

require "bundler/setup"
require "blink1_team_alerter"
require 'optparse'

options = {}
options[:url] = ENV["URL"]

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: check_jira [options]"

  opts.on("-u", "--username=<USERNAME>", "JIRA username") do |r|
    options[:username] = r
  end
  opts.on("-p", "--password=<PASSWORD>", "JIRA password") do |r|
    options[:password] = r
  end
  opts.on("-h", "--host=<HOST>", "JIRA Host Name") do |r|
    options[:host] = r
  end
  opts.on("-k", "--project_key=<PROJECTKEY>", "JIRA project key") do |r|
    options[:project_key] = r
  end
  opts.on("-s", "--search_filter=<search_filter>", "JIRA search filter") do |r|
    options[:search_filter] = r
  end
end

begin
  optparse.parse!
  mandatory = [:username, :password, :host, :project_key]
  missing = mandatory.select{ |param| options[param].nil? }
  unless missing.empty?
    puts "Missing options: #{missing.join(', ')}"
    puts optparse
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  puts optparse
  exit
end

Blink1TeamAlerter.check_for_alerts options[:username], options[:password], options[:host], options[:project_key], options[:search_filter]
